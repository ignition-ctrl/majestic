#!/usr/bin/env bash
#
# Arquivo: ~/.local/bin/screenshot
#
# Script para criar screencasts(vídeos da captura de tela) usando o ffmpeg.
#
# Desenvolvido por Lucas Saliés Brum <lucas@archlinux.com.br>
#
# Criado em: 09/06/2017 23:26:41
# Última Atualização: 31/10/2018 12:35:15

# ultrafast,superfast,veryfast,faster,fast,medium,slow,slower,veryslow,placebo
PRESET="ultrafast"
EXT="mp4"
DATA=$(date +%H-%M-%S)
ICONE="${HOME}/.local/share/icons/elementary/video-display.png"
RESOLUCAO=$(xrandr | grep '*' | awk 'NR==1{print $1}')

APPS=("ffmpeg" "xrandr" "pacmd")
for APP in ${APPS[@]}
do
    command -v $APP >/dev/null 2>&1 || { echo >&2 "O aplicativo $APP não está instalado. Abortando."; exit 1; }
done

if [ -f ~/.config/user-dirs.dirs ]; then
    . ~/.config/user-dirs.dirs
    CAMINHO="${XDG_VIDEOS_DIR}/screencast"
else
    CAMINHO="${HOME}/video/screencast"
fi

CAMINHO="${CAMINHO}/$(date +%Y)/$(date +%m)/$(date +%d)"
ARQUIVO="screencast-${DATA}.${EXT}"
FINAL="/tmp/screencast.${EXT}"
STEP1="/tmp/screencast.step1.${EXT}"
STEP2="/tmp/screencast.step2.${EXT}"

[ ! -d $CAMINHO ] && mkdir -p $CAMINHO

#if pgrep -x "ffmpeg" > /dev/null;
if test -f "/tmp/videodown.pid";
then
    notify-send -i $ICONE "ScreenCast" "ScreenCast terminado"
    
    kill -9 $(cat /tmp/videodown.pid)

    notify-send -i $ICONE "ScreenCast" "Conversão para o WhatsApp"
    ffmpeg -i "$(cat /tmp/videodown.step1.file)" -c:v libx264 -profile:v baseline -level 3.0 -pix_fmt yuv420p "$(cat /tmp/videodown.step2.file)"
    rm -f "$(cat /tmp/videodown.step1.file)"
    
    notify-send -i $ICONE "ScreenCast" "Corte de 2 segundos" 
    ffmpeg -ss 2 -i "$(cat /tmp/videodown.step2.file)" "$(cat /tmp/videodown.final.file)"
    rm -f "$(cat /tmp/videodown.step2.file)"

    mv "$(cat /tmp/videodown.final.file)" "${CAMINHO}/${ARQUIVO}"

    notify-send -i $ICONE "ScreenCast" "ScreenCast salvo ${ARQUIVO}" 
    rm -f /tmp/videodown.pid
    exit 0
else
    if ! test -f "/tmp/videodown.pid";
    then
        echo $$ > /tmp/videodown.pid
        echo "${STEP1}" > /tmp/videodown.step1.file
        echo "${STEP2}" > /tmp/videodown.step2.file
        echo "${FINAL}" > /tmp/videodown.final.file

        notify-send -i $ICONE "ScreenCast" "ScreenCast iniciado\n\nPID: $(cat /tmp/videodown.pid)"
    
        #ffmpeg -async 1 -f x11grab -s $RESOLUCAO -i $DISPLAY -f pulse -ac 2 -i default -c:v libx264 -crf 23 -c:a aac -ac 2 -b:a 128k -movflags faststart ${ARQUIVO}.tmp.${EXT}
        ffmpeg -async 1 -f x11grab -s $RESOLUCAO -i $DISPLAY -f pulse -ac 2 -i default -c:v libx264 -crf 23 -c:a aac -ac 2 -b:a 128k -movflags faststart "${STEP1}"
    fi
fi