#!/usr/bin/env bash
#
# github - Script para enviar automaticamente mudanças ao Github
# LEMBRE-SE DE CONFIGURAR CORRETAMENTE SEU GIT SEM SENHA!!!
#
# Desenvolvido por Lucas Saliés Brum <lucas@archlinux.com.br>
#
# Sugestão de crontab:
# */15 * * * * /usr/bin/bash -c "$HOME/.local/bin/github" 2>&1
#
# Criado em: 20/12/2017 19:27:31
# Última Atualização: 28/08/2020 07:30:01

nome="GitHub"
usuario="sistematico"
dir="${HOME}/github"
repos=($(ls -d ${dir}/*))
icone="${HOME}/.local/share/icons/elementary/github.svg"
som="complete"

atualiza() {
    if [ -f ${1}/.github.lock ]; then
        return
    fi

    if ! grep -q $usuario "${1}/.git/config"; then
        echo "$1 não é um repositório válido e/ou seu."
        return
    fi

    if [ ! -d ${1} ]; then
        echo "$1 não é um diretório válido."
        return
    fi
    
    cd ${1}
    status=$(git add . -n)
    if [ ! -z "${status}" ]; then
        c=$(echo $(git add . -n | tr '\r\n' ' '))
        m="Autocommit por ${nome}: alterações: $c"
        git add .
        git commit -m "${m}"
        git push
        if [ "$?" == 0 ]; then
            notify-send "-h int:transient:1" -i "${icone}" "${nome}" "Repo <b>$(basename $1)</b> atualizado."
            [ -f /tmp/git-cron.error ] && rm /tmp/git-cron.error
        else
            if [ ! -f /tmp/git-cron.error ]; then
                icone="${HOME}/.local/share/icons/elementary/network-error.png"
                notify-send "-h int:transient:1" -i "${icone}" "${nome}" "Erro ao atualizar <b>$(basename $1)</b>."
                touch /tmp/git-cron.error
            fi
        fi
    fi
}

echo $#
#if [ "$#" -ne 1 ] || ! [ -d "$1" ]; then

if [ ! ${1} ] || [ "${1}" == "-a" ]; then
    for r in "${repos[@]}";	do
        #caminho="${dir}/${r}"
        atualiza "${r}"
    done
elif [ ! $2 ]; then
    atualiza "$1"
else
    for r in "$@";	do
        #caminho="${dir}/${r}"
        atualiza "$caminho"
    done
fi
