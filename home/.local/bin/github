#!/usr/bin/env bash
#
# github - Script para enviar automaticamente mudanças ao Github
# LEMBRE-SE DE CONFIGURAR CORRETAMENTE SEU GIT SEM SENHA!!!
#
# Desenvolvido por Lucas Saliés Brum <lucas@archlinux.com.br>
#
# Sugestão de crontab:
# */15 * * * * /usr/bin/bash -c "$HOME/.local/bin/github" 2>&1
#
# Criado em: 20/12/2017 19:27:31
# Última Atualização: 28/08/2020 07:30:01

nome="GitHub"
dir="${HOME}/github"
repos=(
	'pagseguro'
    'beats'
    'php-text-counter'
    'dotfiles'
    'sistematico.github.io'
    'php-stars'
	'php-template-engine'
    'php-rest-api'
    'php-rest-front'
    'php-mvc'
    'php-mvc-ajax'
    'php-mvc-users'
    'php-mvc-lite'
    'mudancaonline'
    'mudancaonlineapp'
    'startpage'
    'clima'
    'conversero'
    'zen'
    'somdomato'
    'lucasbrum'
)
remoto="nginx@hera"
dotfiles=1
icone="${HOME}/.local/share/icons/elementary/github.svg"
som="complete"

atualiza() {
	if [ -d $1 ]; then
		if [ ! -f $1/.noup ]; then
			cd $1
			status=$(git add . -n)
			if [ ! -z "$status" ]; then
				c=$(echo $(git add . -n | tr '\r\n' ' '))
				m="Autocommit por ${nome}: alterações: $c"
				git add .
				git commit -m "$m"
				git push
				if [ "$?" == 0 ]; then
					DISPLAY=:0 $HOME/bin/notify.sh "$nome" "Repo <b>$(basename $1)</b> atualizado." "$nome" "$icone"
					[ -f /tmp/git-cron.error ] && rm /tmp/git-cron.error
				else
					if [ ! -f /tmp/git-cron.error ]; then
						icone="${HOME}/.local/share/icons/elementary/network-error.png"
						som="dialog-warning"
						DISPLAY=:0 $HOME/bin/notify.sh "$nome" "Erro ao atualizar <b>$(basename $1)</b>." "$nome" "$icone"
						touch /tmp/git-cron.error
					fi
				fi
			fi
		fi
	fi
}

if [ ! $1 ] || [ "$1" == "-a" ]; then
	for r in "${repos[@]}";	do
		caminho="${dir}/${r}"
		atualiza "$caminho"
	done

	[ $dotfiles == 1 ] && atualiza "${HOME}/majestic"
	[ "$1" == "-a" ] && ssh $remoto "/usr/local/scripts/github"
elif [ ! $2 ]; then
	atualiza "$1"
else
	for r in "$@";	do
		caminho="${dir}/${r}"
		atualiza "$caminho"
	done
fi

